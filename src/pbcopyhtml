#!/bin/bash

# pbcopyhtml: Copy HTML and Plain Text to the macOS clipboard simultaneously.
# Usage:
#   1. printf '<b>html</b>' | ./pbcopyhtml
#      (Sets both flavors to the same content)
#   2. ./pbcopyhtml <html_file> <text_file>
#      (Sets flavors to different content)

if [ "$#" -eq 2 ]; then
    HTML_PATH="$1"
    TEXT_PATH="$2"
    echo "[pbcopyhtml] Using provided files: HTML=$HTML_PATH, TEXT=$TEXT_PATH"
else
    # Fallback to stdin if no files provided
    TMP_IN=$(mktemp /tmp/pbcopyhtml.XXXXXX)
    cat > "$TMP_IN"
    HTML_PATH="$TMP_IN"
    TEXT_PATH="$TMP_IN"
    CLEANUP=true
    echo "[pbcopyhtml] Using stdin, temp file: $TMP_IN"
fi

# 1. Generate hex for HTML
HTML_HEX=$(hexdump -ve '1/1 "%.2x"' < "$HTML_PATH")
echo "[pbcopyhtml] HTML hex length: ${#HTML_HEX}"

# 2. Use osascript to set both
# We read the text part as UTF-8
echo "[pbcopyhtml] Running osascript..."
osascript <<EOF
set theText to (read (POSIX file "${TEXT_PATH}") as «class utf8»)
set the clipboard to {«class HTML»:«data HTML${HTML_HEX}», text:theText}
EOF
echo "[pbcopyhtml] Done."

# Clean up if we used a temp file
if [ "$CLEANUP" = true ]; then
    rm "$TMP_IN"
fi